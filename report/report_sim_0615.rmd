---
title: "simulation"
author: ""
date: '`r Sys.Date()`'
output:
  html_document:
    highlight: py
    css: "style.css"
    code_folding: show
    toc: true
    toc_depth: 2
    toc_float:
      collapsed: false
      smooth_scroll: false
editor_options:
  chunk_output_type: console
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(
  eval = T,
  echo = F,
  fig.height = 12,
  fig.width = 24,
  out.width = '150%',
  warning = FALSE,
  message = F,
  include = T
)
library(rstan); library(tidyverse); library(knitr);library(ggforce);
library(cowplot)

library(grid)
library(gridExtra)

base_path <- rprojroot::find_rstudio_root_file()

# theme_set(theme_bw(base_size = 24))

library(tidyverse)
library(rstan)
# library(coda)
#
data_idx <- "0608"

mpart <- readRDS(paste0(base_path,"/","test/shinydata/", data_idx, "_mpart.rds"))

rds_files <- fs::dir_ls(file.path(base_path, "test/outlier_check"))

outlierfiles <- str_subset(rds_files, "check/outlier_")
unbiasedfiles <- str_subset(rds_files, "unbiased_")
middlefiles <- str_subset(rds_files, "middle_")

a1 <- mpart %>%
  filter(str_detect(par_name,"lambda") ) %>%
  # filter(lvmodel != "rasch") %>%
  separate(cond,
           c("lvmodel","samplesize","nitem","r2y","r2eta","linearity","outdist","rep"), "_") %>%
  mutate(
    overest = err > 0,
    underest = err < 0,
    evenest  = err == 0
  )

a1 <- mpart %>%
  filter(str_detect(par_name,"lambda") ) %>%
  separate(cond,
           c("lvmodel","samplesize","nitem","r2y","r2eta","linearity","outdist","rep"), "_") %>%
  mutate(
    overest = err > 0,
    underest = err < 0,
    evenest  = err == 0
  ) %>%
  filter(!str_detect(lvmodel, "normal|logn|unif"))

outliers <- a1 %>%
  filter(err != 0) %>%
  # filter(lvmodel == invest_lvm) %>%
  # filter(samplesize == invest_ss, nitem == invest_ni) %>%
  select(lvmodel, samplesize, nitem, rep, par_name, err, true_param, mean, X2.5., X97.5., Rhat) %>%
  arrange(-abs(err)) %>%
  slice(1:10)


set.seed(1)
unbiased <- a1 %>%
  filter(err != 0) %>%
  select(lvmodel, samplesize, nitem, rep, par_name, err, true_param, mean, X2.5., X97.5., Rhat) %>%
  filter(abs(err) < 0.1 ) %>%
  sample_n(10)

set.seed(1)
middle <- a1 %>%
  filter(err != 0) %>%
  select(lvmodel, samplesize, nitem, rep, par_name, err, true_param, mean, X2.5., X97.5., Rhat) %>%
  filter(abs(err) < 0.5 & abs(err) > 0.1 ) %>%
  sample_n(10)
```


## Outliers results {.tabset}

### Table

```{r}
outliers %>% kable()
```

### trace plot

```{r, results = 'asis'}

for(i in 1:10) {
  o1 <- readRDS(outlierfiles[i])
  #### 
  cat("\n\n#### ", o1$cond, "\n\n")
  
  pp <- o1$p + labs(title = o1$cond) +
    theme(text = element_text(size = 40),
      plot.title = element_text(size = 40),
      axis.title = element_text(size = 40),
      legend.title = element_text(size = 40)
      )
  print(pp)
  
  cat('\n<div class = "row">',"\n\n")
  cat('\n<div class="column2-left">',"\n\n")
  
  cbind(true_v = o1$true_v, o1$est_v) %>% 
    data.frame() %>% 
    tibble(bias = o1$bias) %>% 
    select(true_v, mean, bias, sd, Rhat) %>% 
    mutate_all(round, 3) %>% 
    kable() %>% 
    print()
  cat('\n</div>',"\n\n")
  
  cat('\n<div class="column2-right">',"\n\n")
  
  o1$modelconver$autocr %>% 
    data.frame() %>% 
    setNames("autocorr") %>% 
    mutate_all(round, 3) %>% 
    kable() %>% 
    print()
  
  
  cat('\n</div>',"\n\n")
  cat('\n</div>',"\n\n")
  
  cat("\n\n")
  
}
```


## Unbiased results {.tabset}

### Table

```{r}
unbiased %>% kable()
```

### trace plot

```{r, results = 'asis'}

for(i in 1:10) {
  o1 <- readRDS(unbiasedfiles[i])
  
  cat("\n\n#### ", o1$cond, "\n\n")
  
  pp <- o1$p + labs(title = o1$cond) +
    theme(
      text = element_text(size = 40),
      plot.title = element_text(size = 40),
      axis.title = element_text(size = 40),
      legend.title = element_text(size = 40)
      )
  print(pp)
  
  cat('\n<div class = "row">',"\n\n")
  cat('\n<div class="column2-left">',"\n\n")
  
  cbind(true_v = o1$true_v, o1$est_v) %>% 
    data.frame() %>% 
    tibble(bias = o1$bias) %>% 
    select(true_v, mean, bias, sd, Rhat) %>% 
    mutate_all(round, 3) %>% 
    kable() %>% 
    print()
  cat('\n</div>',"\n\n")
  
  cat('\n<div class="column2-right">',"\n\n")
  
  o1$modelconver$autocr %>% 
    data.frame() %>% 
    setNames("autocorr") %>% 
    mutate_all(round, 3) %>% 
    kable() %>% 
    print()
  
  
  cat('\n</div>',"\n\n")
  cat('\n</div>',"\n\n")
  
  cat("\n\n")
  
}
```

